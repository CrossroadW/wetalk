# 数据缓存机制 - 增量更新流程

> 客户端通过 start/end 区间管理本地缓存，按需双向加载消息。数据模型详见 [data-models.md](./data-models.md)

## 缓存区间

```
服务器消息序列：[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, ...]
                    ↑              ↑
客户端缓存区间：   start=3        end=8
                [3, 4, 5, 6, 7, 8]
```

## 1. 首次登录（冷启动）

本地无消息，发送 `fetch(after_id=0)`，服务器分页返回最早的连续消息序列。

```
本地数据库为空
       ↓
fetch(after_id=0, limit=50)
       ↓
服务器返回: [1, 2, ..., 50]
       ↓
插入本地数据库
       ↓
缓存区间: start=1, end=50
```

## 2. 向上滚动（加载历史消息）

用户滚动到 start 边缘，触发 `fetch(before_id=start)`，服务器返回更早的连续序列，插入本地数据库，更新 start。

```
当前缓存: [3, 4, 5, ..., 50]  start=3
       ↓
fetch(before_id=3, limit=50)
       ↓
服务器返回: [1, 2]
       ↓
新缓存: [1, 2, 3, 4, 5, ..., 50]  start=1
```

## 3. 向下滚动（加载新消息）

用户滚动到 end 边缘，触发 `fetch(after_id=end)`，服务器返回更新的连续序列，插入本地数据库，更新 end。

```
当前缓存: [1, 2, ..., 50]  end=50
       ↓
fetch(after_id=50, limit=50)
       ↓
服务器返回: [51, 52, ..., 80]
       ↓
新缓存: [1, 2, ..., 80]  end=80
```

## 4. 实时推送（WebSocket）

WebSocket 推送新消息，直接插入本地数据库，更新 end。

```
WebSocket 推送: message(id=81)
       ↓
插入本地数据库
       ↓
end=81, UI 刷新
```
